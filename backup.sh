#!/bin/sh
set -e

#--------------------------------------------------------------------------------------------------
# Syntax
#--------------------------------------------------------------------------------------------------

if [ $# != 2 ]; then

    echo "Usage: backup <archive> <path>"

    exit 1
fi

#--------------------------------------------------------------------------------------------------
# Stop
#--------------------------------------------------------------------------------------------------

echo "STOP"

sudo systemctl stop nginx

#--------------------------------------------------------------------------------------------------
# Backup SQL
#--------------------------------------------------------------------------------------------------

echo ""
echo "BACKUP SQL"

SQL_BACKUP_PATH="backup/sql-peertube_prod-$(date -Im).bak"

cd /var/www/peertube && sudo -u peertube mkdir -p backup

sudo -u postgres pg_dump -F c peertube_prod | sudo -u peertube tee "$SQL_BACKUP_PATH" >/dev/null

sudo cp "$SQL_BACKUP_PATH" "$2/sql-peertube_prod.bak"

#--------------------------------------------------------------------------------------------------
# Create archive
#--------------------------------------------------------------------------------------------------

echo ""
echo "CREATE ARCHIVE"

cd "$2"

tar -cvzf $1 sql-peertube_prod.bak /var/www/peertube/storage

#--------------------------------------------------------------------------------------------------
# Clean
#--------------------------------------------------------------------------------------------------

echo ""
echo "CLEAN"

rm sql-peertube_prod.bak

#--------------------------------------------------------------------------------------------------
# Restart
#--------------------------------------------------------------------------------------------------

echo ""
echo "RESTART"

sudo systemctl start nginx

sudo systemctl daemon-reload

sudo systemctl restart peertube
